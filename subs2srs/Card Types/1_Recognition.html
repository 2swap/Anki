<textarea type="text" id="type_input"></textarea>

<div class="front">
  <div id="subs2srs_pic" style="display: none;">
    {{Pic1}}
  </div>
  <div id="text" style="padding:10px"></div>
  <div id="translation"></div>
  <div id="audio" style="display: none;">
    {{Audio}}
  </div>
</div>

<script>
  function stringToColor(str) {
    const brightness = 32;
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }

    let color = 'rgb(';
    for (let i = 0; i < 3; i++) {
      let value = (hash >> (i * 8)) & 0xFF;
      value = Math.floor(value % (256-brightness)) + brightness;
      color += value + (i < 2 ? ',' : '');
    }
    color += ')';
    return color;
  }

  var textElement = document.getElementById("text");
  var translationElement = document.getElementById("translation");
  var typeElement = document.getElementById("type_input");
  var text = `{{Text}}`;
  var translation = `{{Translation}}`;
  var wordMap;
  if(text.startsWith("(")){
    text = "Er ist ein typischer Arbeitshai.";
    translation = "He is a typical workaholic.";
    wordMap = {"Er":"He", "ist":"is", "ein":"a", "typischer":"typical", "Arbeitshai":"workaholic"};
  }else{
    wordMap = JSON.parse(`{{WordMap}}`);
  }
  var reverseWordMap = {};
  for (var originalWord in wordMap) {
    reverseWordMap[wordMap[originalWord]] = originalWord;
  }

  function normz(input) {
    return input.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ÃŸ/g,"ss").toLowerCase();
  }

  function sanitizeAndSplit(text) {
    // Remove punctuation with a regex, then split by whitespace
    return text.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()\?]/g,"").split(/\s+/);
  }
  var words = sanitizeAndSplit(text);
  var translationWords = sanitizeAndSplit(translation);

  var guessedWords = [];
  var guessedTranslation = [];

  function updateShownText() {
    var shownText = '';
    for (var i = 0; i < words.length; i++) {
      var word = words[i];
      var show = guessedWords.some(guess => normz(guess) === normz(word));
      var color = show ? stringToColor(word) : 'inherit';
      shownText += `<span style="color:${color}">` + (show ? word : `&nbsp`.repeat(word.length)) + '</span>' + `&nbsp`;
    }
    textElement.innerHTML = shownText;

    var shownTranslation = '';
    for (var i = 0; i < translationWords.length; i++) {
      var word = translationWords[i];
      var originalWord = reverseWordMap[word];
      var show = guessedTranslation.some(guess => normz(guess) === normz(word));
      var color = show && originalWord ? stringToColor(originalWord) : 'inherit';
      shownTranslation += `<span style="color:${color}">` + (show ? word : `&nbsp`.repeat(word.length)) + '</span>' + `&nbsp`;
    }
    translationElement.innerHTML = shownTranslation;
  }
  updateShownText();

  // Clear all existing timeouts
  var id = window.setTimeout(function() {}, 0);
  while (id--) {
    window.clearTimeout(id); // will do nothing if no timeout with id is present
  }

  document.getElementById("type_input").addEventListener('input', function() {
    var inputValue = this.value.trim();
    var matchedWord = words.find(word => normz(word) === normz(inputValue));
    if (matchedWord && !guessedWords.includes(matchedWord)) {
      guessedWords.push(matchedWord);
      guessedTranslation.push(wordMap[matchedWord]);
      this.value = '';
      updateShownText();

      var audioElement = document.getElementById("audio");
      var clone = audioElement.cloneNode(true);
      clone.removeAttribute("id");
      var elem = document.querySelector(".soundLink, .replaybutton");
      if (elem) { elem.click(); }
    }
  });

  if(document.getElementById("back")){
    var elem = document.querySelector(".soundLink, .replaybutton");
    if (elem) { elem.click(); }
    document.getElementById('type_input').remove();
    guessedWords = words;
    guessedTranslation = translationWords;
    updateShownText();
    document.getElementById("subs2srs_pic").style.display = "block";
    setTimeout(function() {document.getElementById("subs2srs_pic").innerHTML = `{{Pic2}}`;}, 1800);
  } else {
    document.getElementById('type_input').focus();
  }
  typeElement.addEventListener("keydown", function () {
    if (event.key == "Enter") typeElement.blur();
  });

</script>


